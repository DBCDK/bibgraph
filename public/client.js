// Generated by CoffeeScript 1.6.2
(function() {
  var $graph, draw, edgeTry, existing, expand, klynger, nNodes, pick, prng, requestKlynge, reset, search, start, update, _pickN;

  nNodes = 70;

  edgeTry = 6;

  klynger = [];

  draw = function() {
    var a, b, edges, force, h, i, idx, klynge, link, node, svg, updateForce, w, _i, _j, _k, _l, _len, _len1, _len2, _len3, _m, _ref, _ref1;

    klynger = klynger.reverse();
    w = window.innerWidth;
    h = window.innerHeight;
    force = d3.layout.force();
    document.getElementById("graph").innerHTML = "";
    svg = d3.select("#graph").append("svg");
    svg.attr("width", w);
    svg.attr("height", h);
    for (i = _i = 0, _ref = klynger.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
      klynger[i].index = i;
    }
    for (_j = 0, _len = klynger.length; _j < _len; _j++) {
      klynge = klynger[_j];
      klynge.label = String(klynge.title).replace("&amp;", "&").replace(/&#([0-9]*);/g, function(_, n) {
        return String.fromCharCode(n);
      });
    }
    idx = {};
    for (_k = 0, _len1 = klynger.length; _k < _len1; _k++) {
      klynge = klynger[_k];
      idx[klynge.klynge] = klynge.index;
    }
    edges = [];
    for (_l = 0, _len2 = klynger.length; _l < _len2; _l++) {
      a = klynger[_l];
      _ref1 = a.adhl.slice(0, edgeTry);
      for (_m = 0, _len3 = _ref1.length; _m < _len3; _m++) {
        b = _ref1[_m];
        if (typeof idx[b.klynge] === "number") {
          edges.push({
            source: a.index,
            target: idx[b.klynge]
          });
        }
      }
    }
    link = svg.selectAll(".link").data(edges).enter().append("line").attr("class", "link").style("stroke", "#999").style("stroke-width", 1);
    node = svg.selectAll(".node").data(klynger).enter().append("text").style("font", "12px sans-serif").style("text-anchor", "middle").style("text-shadow", "1px 1px 0px white, -1px -1px 0px white, 1px -1px 0px white, -1px 1px 0px white").attr("class", "node").call(force.drag);
    updateForce = function() {
      link.attr("x1", function(d) {
        return d.source.x;
      }).attr("y1", function(d) {
        return d.source.y;
      }).attr("x2", function(d) {
        return d.target.x;
      }).attr("y2", function(d) {
        return d.target.y;
      });
      return node.attr("x", function(d) {
        return d.x;
      }).attr("y", function(d) {
        return d.y + 2;
      }).text(function(d) {
        return d.label || d._id;
      });
    };
    force.size([w, h]);
    force.on("tick", function() {
      return updateForce();
    });
    force.nodes(klynger);
    force.links(edges);
    force.charge(-120);
    force.linkDistance(100);
    force.linkStrength(0.3);
    force.gravity(0.1);
    return force.start();
  };

  reset = function() {
    var existing, _pickN;

    existing = {};
    _pickN = 0;
    return window.klynger = klynger = [];
  };

  start = function(done) {
    if (klynger.length) {
      expand(done);
    }
    return update();
  };

  prng = function(n) {
    return (1664525 * n + 1013904223) | 0;
  };

  _pickN = 0;

  pick = function(arr) {
    _pickN = prng(_pickN);
    return arr[(_pickN & 0x7fffffff) % arr.length];
  };

  existing = {};

  expand = function(done) {
    var child, i, klynge, _i, _j, _k, _len, _len1, _ref;

    if (klynger.length >= nNodes) {
      return typeof done === "function" ? done() : void 0;
    }
    for (_i = 0, _len = klynger.length; _i < _len; _i++) {
      klynge = klynger[_i];
      existing[klynge.klynge] = true;
    }
    for (i = _j = 0; _j <= 20; i = ++_j) {
      klynge = klynger[Math.random() * klynger.length | 0];
      klynge = pick(klynger);
      _ref = klynge.adhl;
      for (_k = 0, _len1 = _ref.length; _k < _len1; _k++) {
        child = _ref[_k];
        if (!existing[child.klynge]) {
          existing[child.klynge] = true;
          return requestKlynge(child.klynge, function() {
            return expand(done);
          });
        }
      }
    }
  };

  requestKlynge = function(klyngeId, done) {
    return $.get("klynge/" + klyngeId, function(klynge) {
      if (!klynge.faust) {
        return typeof done === "function" ? done() : void 0;
      }
      klynger.push(klynge);
      return $.get("faust/" + klynge.faust[0], function(faust) {
        klynge.title = faust.title;
        update();
        return typeof done === "function" ? done() : void 0;
      });
    });
  };

  $graph = void 0;

  $(function() {
    return $graph = $("#graph");
  });

  update = function() {
    var klynge, _i, _len, _results;

    $graph.empty();
    klynger = klynger.filter(function(klynge) {
      return klynge.adhl;
    });
    _results = [];
    for (_i = 0, _len = klynger.length; _i < _len; _i++) {
      klynge = klynger[_i];
      _results.push($graph.append("<span> &nbsp; " + klynge.title + " " + klynge.count + "</span>"));
    }
    return _results;
  };

  search = function() {
    var query;

    reset();
    query = ($("#query")).css({
      display: "none"
    }).val();
    location.hash = query;
    klynger = [];
    qp.log("search", query);
    return $.get("search/" + query, function(result) {
      ($("#query")).css({
        display: "inline"
      }).val("");
      return async.map(result, function(faust, done) {
        return $.get("faust/" + faust, function(faust) {
          if (faust != null ? faust.klynge : void 0) {
            return requestKlynge(faust != null ? faust.klynge : void 0, done);
          } else {
            return done();
          }
        });
      }, function() {
        var klynge, max, _i, _len;

        return start(function() {
          return draw();
        });
        klynger = klynger.slice(0, 1);
        return start(function() {
          return draw();
        });
        max = {
          count: 0
        };
        for (_i = 0, _len = klynger.length; _i < _len; _i++) {
          klynge = klynger[_i];
          if (max.count <= klynge.count) {
            max = klynge;
          }
        }
        klynger = [max];
        console.log("root:", max);
        return start(function() {
          return console.log("done");
        });
      });
    });
  };

  $(function() {
    ($("#search")).on("submit", function() {
      search();
      return false;
    });
    if (location.hash) {
      ($("#query")).val(location.hash.slice(1));
      search();
    }
    return ($("#search")).focus();
  });

}).call(this);
